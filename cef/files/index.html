<!--Main page displayed by the launcher. Basically just a javascript file with a couple of HTML tags around it.-->
<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<title>Bolt Launcher</title>
		<script>
			var credentials = null;

			// checks if `credentials` are about to expire or have already expired,
			// and renews them using the oauth endpoint if so
			function checkRenewCreds(url, client_id) {
				return new Promise((resolve, reject) => {
					// only renew if less than 30 seconds left
					if (credentials.expiry - Date.now() < 30000) {
						const post_data = new URLSearchParams({
							grant_type: "refresh_token",
							client_id: client_id,
							refresh_token: credentials.refresh_token
						});
						var xml = new XMLHttpRequest();
						xml.onreadystatechange = () => {
							if (xml.readyState == 4 && xml.status == 200) {
								parseCredentials(xml.response);
								resolve(null);
							} else if (xml.status >= 400) {
								reject(xml.status);
							}
						};
						xml.open('POST', url, true);
						xml.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
						xml.setRequestHeader("Accept", "application/json");
						xml.send(post_data);
					} else {
						resolve(null);
					}
				});
			}

			// parses a response from the oauth endpoint into the `credentials` var
			function parseCredentials(str) {
				const oauth_creds = JSON.parse(str);
				const sections = oauth_creds.id_token.split('.');
				if (sections.length !== 3) {
					throw new Exception(
						"<p>Malformed id_token: "
						.concat(sections.length)
						.concat(" sections")
						.concat("</p>")
					);
				}
				const header = JSON.parse(atob(sections[0]));
				if (header.typ !== "JWT") {
					throw new Exception(
						"<p>Bad id_token header: typ should be JWT, but is "
						.concat(header.typ)
						.concat("</p>")
					);
				}
				const payload = JSON.parse(atob(sections[1]));
				credentials = {
					access_token: oauth_creds.access_token,
					id_token: oauth_creds.id_token,
					refresh_token: oauth_creds.refresh_token,
					sub: payload.sub,
					login_provider: payload.login_provider || null,
					expiry: Date.now() + (oauth_creds.expires_in * 1000)
				};
				console.log(credentials);
			}

			// builds the url to be opened in the login window
			// async because crypto.subtle.digest is async for some reason, so remember to `await`
			async function makeLoginUrl(e) {
				const verifier_data = new TextEncoder().encode(e.pkceCodeVerifier);
				const digested = await crypto.subtle.digest("SHA-256", verifier_data);
				var raw = "";
				var bytes = new Uint8Array(digested);
				for (var i = 0; i < bytes.byteLength; i++) {
					raw += String.fromCharCode(bytes[i]);
				}
				const code_challenge = btoa(raw).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
				return e.origin.concat("/oauth2/auth?").concat(new URLSearchParams({
					auth_method: e.authMethod,
					login_type: e.loginType,
					flow: e.flow,
					response_type: "code",
					client_id: e.clientid,
					redirect_uri: e.redirect,
					code_challenge: code_challenge,
					code_challenge_method: "S256",
					prompt: "login",
					scope: "openid offline gamesso.token.create user.profile.read",
					state: e.pkceState
				}));
			}

			// builds a random PKCE verifier string using crypto.getRandomValues
			function make_random_verifier() {
				var t = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~";
				var n = new Uint32Array(43);
				crypto.getRandomValues(n);
				return Array.from(n, function(e) {
					return t[e % t.length]
				}).join("")
			}

			// builds a random PKCE state string using crypto.getRandomValues
			function make_random_state() {
				var t = 0;
				var r = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
				var n = r.length - 1;
	
				var o = crypto.getRandomValues(new Uint8Array(12));
				return Array.from(o).map(function(e) {
					return Math.round(e * (n - t) / 255 + t)
				}).map(function(e) {
					return r[e]
				}).join("")
			}

			// body's onload function
			function start(s) {
				const state = make_random_state();
				const verifier = make_random_verifier();
				const client_id = atob(s.clientid);
				var w = window.open("about:blank", "", "width=480,height=720");
				window.addEventListener("message", (event) => {
					if (event.origin != "https://bolt-internal" && btoa(event.origin).replaceAll('\x3d', '') != s.origin) {
						console.log(`discarding message from origin ${event.origin}`);
						return;
					}
					switch (event.data.type) {
						case "authCode":
							if (event.data.state == state) {
								const exchange_url = atob(s.origin).concat("/oauth2/token");
								const post_data = new URLSearchParams({
									grant_type: "authorization_code",
									client_id: atob(s.clientid),
									code: event.data.code,
									code_verifier: verifier,
									redirect_uri: atob(s.redirect)
								});
								var xml = new XMLHttpRequest();

								xml.onreadystatechange = () => {
									if (xml.readyState == 4 && xml.status == 200) {
										w.close();
										parseCredentials(xml.response);
										switch (credentials.login_provider) {
											case "runescape":
												handleGameLogin(s, exchange_url, client_id);
												break;
											default:
												handleStandardLogin(s, exchange_url, client_id);
												break;
										}
									} else if (xml.status >= 400) {
										w.close();
										document.getElementById("root").innerHTML =
											"Error: from "
											.concat(exchange_url)
											.concat(": ")
											.concat(xml.status)
											.concat(" ")
											.concat(xml.response);
									}
								};
								xml.open('POST', exchange_url, true);
								xml.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
								xml.setRequestHeader("Accept", "application/json");
								xml.send(post_data);

							}
							break;
						case "initAuth":
							console.log(`message: init auth: ${event.data.auth_method}`);
							break;
						case "externalUrl":
							console.log(`message: external url: ${event.data.url}`);
							break;
						case "gameSessionServerAuth":
							// not sure what conditions cause this one just yet...
							console.log(`message: game session server auth: id_token ${event.data.id_token}, state ${event.data.state}`);
							break;
						default:
							console.log("unknown message type: ".concat(event.data.type));
							break;
					}
				});
				makeLoginUrl({
					origin: atob(s.origin),
					redirect: atob(s.redirect),
					authMethod: "",
					loginType: "",
					clientid: client_id,
					flow: "launcher",
					pkceState: state,
					pkceCodeVerifier: verifier,
				}).then((e) => { w.location.replace(e); });
			}

			// called when login was successful, but with absent or unrecognised login_provider
			function handleStandardLogin(s, refresh_url, client_id) {

			}

			// called after successful login using a game account as the login_provider
			function handleGameLogin(s, refresh_url, client_id) {
				const auth_url = atob(s.profile_api).concat("/profile");
				var xml = new XMLHttpRequest();
				xml.onreadystatechange = () => {
					if (xml.readyState == 4 && xml.status == 200) {
						const name_info = JSON.parse(xml.response);
						const display_name = name_info.displayNameSet ? name_info.displayName : "";
						const display_name_html = name_info.displayNameSet ? "<b>".concat(name_info.displayName).concat("</b>") : "<i>(no name set)</i>";
						document.getElementById("root").innerHTML =
							"<p>Currently logged in with an RS account</p><p>username: "
							.concat(display_name_html)
							.concat("</p>")
							.concat("<p>account id: ")
							.concat(credentials.sub)
							.concat("</p>")
							.concat("<button onclick=\"launchRs('")
							.concat(atob(s.shield_url))
							.concat("', '")
							.concat(escape(display_name))
							.concat("', '")
							.concat(escape(refresh_url))
							.concat("', '")
							.concat(escape(client_id))
							.concat("')\">Launch</button>");
					}
				};
				xml.open('GET', auth_url, true);
				xml.setRequestHeader("Authorization", "Bearer ".concat(credentials.id_token));
				xml.send();
			}

			// launch game
			function launchRs(url, display_name, refresh_url, client_id) {
				checkRenewCreds(unescape(refresh_url), unescape(client_id)).then(() => {
					var xml = new XMLHttpRequest();
					xml.open('POST', url, true);
					xml.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
					xml.setRequestHeader("Authorization", "Basic Y29tX2phZ2V4X2F1dGhfZGVza3RvcF9yczpwdWJsaWM=");
					xml.onreadystatechange = () => {
						if (xml.readyState == 4 && xml.status == 200) {
							console.log(xml.response);
						}
					};
					xml.send(new URLSearchParams({
						token: unescape(credentials.access_token),
						grant_type: "token_exchange",
						scope: "gamesso.token.create"
					}));
				});
			}
		</script>
	</head>
	<body style="overflow:hidden" onload="start(window.s())">
		<div id="root" />
	</body>
</html>
